---
title: "Results for Paper"
output:
  html_document:
    df_print: paged
---

## Data Preparation

```{r message=FALSE, warning=FALSE}
#Load functions
#Source functions and packages
source("~/covid_simulation/Kin_death/01_load_functions.R")
source('~/covid_simulation/Kin_death/functions_bereavement.R')

#Require this additional packages
require(broom)
require(countrycode)
require(ggrepel)
require(viridis)
require(kableExtra)
require(ISOweek)
require(splitstackshape)
require(gridExtra)
require(ggh4x)
require(zoo)

options(scipen = 999999)

#Load data: currently, this points to the latest version with data for the first wave
data <- get(load(file = "~/covid_simulation/Data/finaldata_monthly.RData"))
```

```{r}
#Find numbers for indices for each country
indices <- data$numbers %>%
  group_by(country) %>%
  summarize(max_index = min(nsims))
```

```{r}
#Burden of bereavement object
kin_ebr <-data$kin_bb %>%
  full_join(., indices, by = c("country" = "country")) %>%
  filter(!is.na(scenario)) %>% 
  mutate(sex = ifelse(grepl("f1", category), "F", "M"),
         age = gsub("f[0-1]{1}", "", category),
         category = NULL) %>%
  ungroup() %>%
  group_by(country, scenario, sex, age, kintype, month) %>%
  mutate(index = row_number(), category = NULL) %>%
  filter(index <= max_index) %>%
  ungroup() %>%
  pivot_wider(id_cols = c("country", "sex", "age", "kintype", "index", "month"), 
              names_from = "scenario", 
              values_from = c("n_withkin", "n_losekin", "n_total", "sim.id")) %>%
  mutate(probloss_covid = 100000*(n_losekin_covid/n_total_covid),
         probloss_other = 100000*(n_losekin_other/n_total_other),
         probloss_abs_diff = probloss_covid - probloss_other,
         probloss_rel_diff = 100*(probloss_abs_diff/probloss_other),
        n_withkin = (n_withkin_covid + n_withkin_other)/2,
         n_total = (n_total_covid + n_total_other)/2,
         pc_withkin = (n_withkin/n_total)*100,
         ccode = countrycode(gsub("_", " ", country), 
                             origin = 'country.name', destination = 'iso3c'))
```

### Death rates
```{r}
#Death rates object
  em <- data$death_rates %>%
  full_join(., indices, by = c("country" = "country")) %>%
  filter(!is.na(scenario)) %>% 
  mutate(sex = ifelse(fem == 1, "F", "M")) %>%
  ungroup() %>%
  group_by(country, scenario, sex, age) %>%
  mutate(index = row_number(), fem = NULL) %>%
  filter(index <= max_index) %>%
  ungroup() %>%
  pivot_wider(id_cols = c("country", "sex", "age", "index"), 
              names_from = "scenario", 
            values_from = c("n_num", "n_den", "value", "sim.id")) %>%
  filter(age %ni% c("all_sum", "all_mid")) %>%
  mutate(age_interval = if_else(age %in% c("0-14"), "0-14", 
         if_else(age %in% c("65+"), "65+", "15-64"))) %>%
  ungroup() %>%
  group_by(index, country, sim.id_covid, sim.id_other, age_interval) %>%
  summarize(n_num_covid = sum(n_num_covid, na.rm = T),
            n_num_other = sum(n_num_other, na.rm = T),
            n_den_covid = sum(n_den_covid, na.rm = T),
            n_den_other = sum(n_den_other, na.rm = T)) %>%
    mutate(n_num_other = if_else(n_num_other == 0, 10^-10, n_num_other),
           mx_ratio_sim = ((n_num_covid/n_den_covid)/(n_num_other/n_den_other)),
           mx_ratio_sim = if_else(mx_ratio_sim == Inf, NaN, mx_ratio_sim))
```

```{r}
#Load data and calculate weekly deaths for counterfactual and Covid cases
stmf <- fread("~/covid_simulation/Rcode/stmf_sep28.csv", stringsAsFactors = F)
names(stmf) <- tolower(names(stmf)) #Make names lowercase

#Keeping only countries that have data for 2021
keepcountry <- unique(stmf %>%
  filter(year == 2021, week >= 26) %>%
  pull(countrycode))


#Pivoting the STMF data into long format
adj.total <- stmf %>%
  dplyr::select(-c(split, splitsex, forecast)) %>% #removing variables
  filter(countrycode %in% keepcountry) %>%
  pivot_longer(-c(year, week, countrycode, sex), 
               names_to = c("type", "age"), 
               values_to = "rate", names_sep = 1) %>% #pivoting
  pivot_wider(names_from = "type", values_from = "rate") %>%
  mutate(death_count = d, #renaming and generating new versions of variables
         death_rate = r,
         age = gsub("85p", "85-99", gsub("_", "-", age)),
         country = countrycode,
         sex = if_else(sex %in% c("f"), "Female", if_else(sex %in% c("m"), "Male", "b"))) %>%
  filter(age != "total", between(year, 2016, 2021), sex != "b") %>%
  mutate(exposure = death_count/death_rate) %>%
  group_by(country, sex, age, year) %>%
  mutate(exposure2 = max(exposure, na.rm = T), #this accounts for the few cases where a weekly exposure is 0 due to no deaths in a group
         exposure_fixed = if_else(is.na(exposure), exposure2, exposure)) %>%
  dplyr::select(-c(exposure, exposure2, d,r, countrycode)) %>% #removing provisional and unnecessary variables
  rename(exposure = exposure_fixed) #specifying final exposure variable


#STMF currently reports the UK estimate for England and Wales, Scotland, and Northern Ireland separately; we combine them into one country and use that estimate for the UK
#Seeing if we need to adjust the UK estimate: we see if we have more than one containing the code GBR
adjustUK <- if_else(length(grep("GBR", levels(as.factor(adj.total$country)))) > 1, T, F)

#Print whether we need to adjust this
print(paste("UK estimate being constructed from", 
            length(grep("GBR", levels(as.factor(adj.total$country)))), "entities"))

if (adjustUK <- T) {
  
  #Now construct a single estimate for the UK
  adj.total.uk <- adj.total %>% 
    filter(grepl("GBR", country)) %>%
    ungroup() %>%
    group_by(year, week, sex, age) %>%
    summarize(death_count = sum(death_count), exposure = sum(exposure), .groups = "keep") %>% #Adding up UK estimates
    mutate(country = "GBR") #Creating one country code
  
  adj.total2 <- adj.total %>% 
    filter(!grepl("GBR", country)) %>% #Combining them with all other countries in the dataset
    bind_rows(adj.total.uk)
} else {
  adj.total2 <- adj.total
}
  
#Now convert weekly data into monthly, and calculate mx values
adj.monthly.pre <- adj.total2 %>%
  mutate(death_count_daily = death_count/7,
         exposure_daily =  exposure/7,
         days = 7) %>%
  ungroup() %>%
  group_by(country, sex, age, year, week) %>%
  expandRows(count = "days") %>%
  mutate(day = row_number()) %>%
  ungroup() %>%
  mutate(date = paste0(year, "-W", str_pad(week, 2, pad = "0")
                       , "-", day),
         value = ISOweek2date(date),
         month = lubridate::month(value),
         stmf_year = year,
         year = lubridate::year(value)) %>%
  filter(year >= 2016)

#Some series only start in 2016, so 2016 January will be incomplete
adj.monthly <- adj.monthly.pre %>%
  mutate(age = if_else(age %ni% c("0-14", "15-64"), "65+", age)) %>%
  group_by(country, year, month, sex, age) %>%
  summarize(death_count = sum(death_count_daily), 
            exposure = sum(exposure_daily)) %>% 
  #generating monthly death counts and exposures
  mutate(period = if_else(year %in% c(2016:2019), "Past", "Current"))

#Making sure this worked
print(paste("UK estimates still need adjusting: ", 
            if_else(length(grep("GBR", levels(as.factor(adj.monthly$country)))) > 1, T, F)))

#Now we can generate mx values for the two periods
adj.past <- adj.monthly %>%  #Calculate average for past 4-year period
  filter(period == "Past") %>%
  ungroup() %>%
  group_by(country, month, sex, age) %>%
  summarize(mean_past_deaths = mean(death_count), 
            mean_past_exposure =  mean(exposure),
            mean_past_mx = mean_past_deaths/mean_past_exposure, .groups = "keep")

#Add on an extra year of data 
#(months of pandemic measure that starts in January 2020)
adj.extra <- adj.past %>%
  mutate(month = month+12)

#Combine together
adj.past <- bind_rows(adj.past, adj.extra) %>%
  filter(month %in% 3:18) %>%
  ungroup() %>%
  group_by(country, age) %>%
  summarize(past_deaths = sum(mean_past_deaths),
            past_exposure = sum(mean_past_exposure),
            past_mx = past_deaths/past_exposure)

adj.current <- adj.monthly %>% filter(period == "Current") %>% #Find current mx values
  ungroup() %>%
  mutate(current_death_count = death_count, 
         current_exposure = exposure,
         month = if_else(year == 2021, month + 12, month)) %>% 
  dplyr::select(-c(year, death_count, exposure, period)) %>%
  filter(month %in% 3:18) %>%
  group_by(country, age) %>%
  summarize(current_deaths = sum(current_death_count),
            current_exposure = sum(current_exposure),
            current_mx = current_deaths/current_exposure)

#Getting final monthly mx values
adj.monthly.final <- right_join(adj.past, adj.current, #Combine past and current values
                               by = c("country" = "country", "age" = "age")) %>%
  mutate(past_mx = if_else(past_mx == 0, 10^-6, past_mx), 
         mx_ratio_stmf = current_mx/past_mx) %>% #Calculate adjustment factor
         mutate(country_name = ifelse(country == "TWN", "China Taiwan Province of China", 
                                      #To match UN rates files
                               countrycode(substr(country, 1, 3), origin = "iso3c", 
                                           destination = "un.name.en")),
         country_name = c(gsub(" ", "_", 
                               gsub("United Kingdom of Great Britain and Northern Ireland",
                                    "United Kingdom", country_name)))) %>%
  filter(country %ni% c("TWN"))
```

```{r}
em.model <- em %>%
  group_by(country, age_interval) %>%
  summarize(estimate = mean(mx_ratio_sim, na.rm = T),
            n = n(), 
            sd = sd(mx_ratio_sim, na.rm = T),
            std.error = sd/sqrt(n),
            upperci = estimate + qnorm(0.975)*std.error,
            lowerci = estimate - qnorm(0.975)*std.error)

em.model.both <- full_join(em.model, 
                           adj.monthly.final, 
                           by = c("country" = "country_name", "age_interval"= "age")) %>%
    mutate(country = gsub("_", " ", country),
           country = if_else(country == "United States of America", "USA", country),
           within_ci = data.table::between(x = mx_ratio_stmf, 
                                           lower = lowerci, upper = upperci,  
                                           incbounds = T)) %>%
  filter(age_interval != "0-14")

#Get the order of countries for later
country.reorder.em <- em.model.both %>%
  filter(age_interval == "65+") %>%
  arrange(estimate) %>%
  pull(country)
```

```{r, fig.height = 6}
#Means by age
em.model.both %>%
  ggplot(aes(x = factor(country, levels = country.reorder.em), 
             y=estimate, ymin=lowerci, ymax=upperci, color = age_interval, group = age_interval)) +
  geom_hline(yintercept=1, linetype="11", colour="grey60") +
    geom_errorbar(width=0.1, position = position_dodge(0.8)) + 
  geom_point(aes(shape = "Simulation Output"), position = position_dodge(0.8)) +
  geom_point(aes(y = mx_ratio_stmf, shape = "STMF Data"), position = position_dodge(0.8)) +
  coord_flip() +
  labs(y = "Ratio of Observed to Expected Age-Specific Mortality Rate", 
       title = "Excess Mortality by Country", 
       x = "Country", color = "Age", shape = "Source") +
  theme(axis.text.x = element_text(size=20),
        title = element_text(size=20))+
  theme_bw()
```

```{r}
countries.close <- em.model.both %>%
    filter(age_interval == "65+", within_ci == TRUE) %>%
  select(country, estimate, mx_ratio_stmf)

#Correlation coefficient
cor.test(countries.close$estimate[em.model.both$age_interval == "65+"], 
    countries.close$mx_ratio_stmf[em.model.both$age_interval == "65+"])

cor.test(em.model.both$estimate[em.model.both$age_interval == "65+"], 
    em.model.both$mx_ratio_stmf[em.model.both$age_interval == "65+"])

#Show countries
countries.close
```

### Main Result: Kin Loss by Age and Sex

```{r}
probloss_compare <- kin_ebr %>%
  filter(pc_withkin > 5, kintype != "all") %>%
  dplyr::select(country, kintype, age, sex, sim.id_covid, sim.id_other, probloss_abs_diff, probloss_other, probloss_rel_diff, month) %>%
  ungroup() %>%
  pivot_longer(cols = starts_with("probloss"), 
               names_to = "measure", values_to = "value") %>%
  ungroup() %>%
  group_by(country, kintype, age, sex, measure, month) %>%
  summarize(estimate = mean(value, na.rm = T),
            sd = sd(value, na.rm = T),
            n = n(), 
            std.error = sd/sqrt(n)) %>%
  mutate(kintype = str_to_title(if_else(kintype == "gparents", "grandparents", kintype)),
         kintype = factor(kintype, levels = c("Grandparents", "Parents", "Siblings", "Children")),
         country = gsub("_", " ", country),
         country = if_else(country == "United States of America", "USA", country),
         country = if_else(country == "United Kingdom", "UK", country),
         sex = if_else(sex == "F", "Female", "Male"), 
         measure = if_else(measure == "probloss_abs_diff", "Excess", if_else(measure == "probloss_other", "Baseline", "Diff")), 
         month = month - 3239,
         year = if_else(month > 12, 2021, 2020),
         month_new = if_else(month>12, month-12, month),
         date = as.yearmon(paste(month_new, year), "%m %Y"),
         lowerci = estimate - (qnorm(0.975)*std.error),
        upperci = estimate + (qnorm(0.975)*std.error))
```
```{r}
#Pick a list of countries to graph results for
country_graph <- c("Sweden", "Norway", "Poland", "Chile", "UK")
```

```{r}
probloss_compare %>%
  filter(country %in% country_graph,
         measure == "Excess", 
         month <= 18) %>%
  ggplot(mapping = 
           aes(x = as.Date(date), 
               y = estimate,
               group = interaction(age, sex))) + 
  geom_ribbon(aes(ymin = lowerci, ymax = upperci), alpha = 0.1) +
  geom_path(aes(color = age, linetype = sex)) +
  facet_grid(rows = vars(kintype), cols = vars(country), scales = "free") +
  theme_bw() +
  labs(x = "Month and Year", y = "Number of bereaved individuals per 100,000", 
       color = "Age", linetype = "Sex",
       title = "Excess Bereavement by Country, March 2020-June 2021") + 
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0),
        panel.spacing.y=unit(.5,"lines")) +
  scale_color_viridis_d() +
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y")

ggsave("~/covid_simulation/Output/paper_figures/compare_excess_monthly.pdf",
       width = 17.8, units = "cm")
```

```{r}
probloss_compare %>%
  filter(country %in% country_graph,
         measure == "Baseline", 
         month <= 18) %>%
  ggplot(mapping = 
           aes(x = as.Date(date), 
               y = estimate,
               group = interaction(age, sex))) + 
  geom_ribbon(aes(ymin = lowerci, ymax = upperci), alpha = 0.1) +
  geom_path(aes(color = age, linetype = sex)) +
  facet_grid(rows = vars(kintype), cols = vars(country), scales = "free") +
  theme_bw() +
  labs(x = "Month and Year", y = "Number of bereaved individuals per 100,000", 
       color = "Age", linetype = "Sex",
       title = "Counterfactual Bereavement by Country, March 2020-June 2021") + 
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0),
        panel.spacing.y=unit(.5,"lines")) +
  scale_color_viridis_d() +
  scale_x_date(date_breaks = "4 months", date_labels = "%b %Y")

ggsave("~/covid_simulation/Output/paper_figures/compare_baseline_monthly.pdf",
       width = 17.8, units = "cm")
```


```{r}
#Summarize baseline loss
probloss_compare %>%
  filter(country %in% country_graph, measure == "Baseline") %>%
  ungroup() %>%
  group_by(age, sex, kintype, date) %>%
  summarize(max_estimate = max(estimate),
            mean_estimate = mean(estimate),
            min_estimate = min(estimate),
            range = range(estimate)) %>%
  filter(kintype == "Grandparents") %>%
  arrange(-range) %>%
  head(5)
```

```{r}
probloss_compare %>%
  filter(country == "UK", kintype == "Grandparents", month == 3, 
         measure == "Baseline", 
         age == "30-44",
         sex == "Female")
```

```{r}
#Seeing how excess compares to baseline
combined <- probloss_compare %>%
  group_by(measure) %>%
  dplyr::select(-c(std.error, sd, n, month_new)) %>%
  pivot_wider(id_cols = c(country, kintype, age, sex, month, date), 
              names_from = measure, values_from = c(estimate, lowerci, upperci))
combined %>%
  ungroup() %>%
  group_by(kintype, age, sex, date) %>%
  filter(kintype == "Grandparents") %>%
  arrange(-estimate_Excess) %>%
  head(5)

combined %>%
  ungroup() %>%
  group_by(kintype, age, sex, date) %>%
  filter(kintype == "Siblings") %>%
  arrange(-estimate_Excess) %>%
  head(5)

```


### Calculating magnitudes

```{r}
#Merging in population figures
require(wpp2019)
```

```{r}
data(popM)
data(popF)
popM$M_2020 <- popM$`2020`
popF$F_2020 <- popF$`2020`

pop_merged <- merge(popM %>% dplyr::select(c(country_code, name, age, M_2020)),
             popF %>% dplyr::select(c(country_code, name, age, F_2020)))
```

```{r}
pop_group <- pop_merged %>%
  pivot_longer(cols = c("M_2020", "F_2020"), 
               names_to = c("sex", "year"), names_sep = "_", 
               values_to = "pop") %>%
  mutate(country = as.character(name),
         country = if_else(country == "United States of America", 
                           "USA", country),
         country = if_else(country == "United Kingdom", "UK", country),
         country = if_else(country == "Czechia", "Czech Republic", country),
         age_group = if_else(age %in% c("0-4", "5-9", "10-14"), "0-14", 
           if_else(age %in% c("15-19", "20-24", "25-29"), "15-29",
                   if_else(age %in% c("30-34", "35-39", "40-44"), "30-44", 
                           if_else(age %in% c("45-49", "50-54", "55-59", "60-64"), 
                                   "45-64", "65+")))))
```

```{r}
pop_final <- pop_group %>%
  group_by(country, age_group, sex) %>%
  summarize(pop = sum(pop)) %>%
  mutate(pop = pop*1000,
         age = age_group) %>%
  ungroup() %>%
  mutate(age_group = NULL,
         sex = if_else(sex == "M", "Male", "Female"))
```

```{r}
#Now merge this in
probloss_pop <- inner_join(probloss_compare %>% filter(measure == "Excess"), 
                          pop_final, 
                          by = c("country", "sex", "age")) %>%
  mutate(estimate = if_else(estimate < 0, 0, estimate),
         magnitude = (estimate*pop)/100000,
         lowerci = magnitude - (qnorm(0.975)*(std.error/(100000))*magnitude),
          upperci = magnitude + (qnorm(0.975)*(std.error/(100000))*magnitude))
```

```{r}
#Plausibility check
#Hillis
probloss_pop %>%
  filter(country == "UK", 
         kintype == "Parents", 
         age == "0-14", 
         month <= 16) %>%
  ungroup() %>%
  summarize(orphans_UK = sum(magnitude),
            upperci = sum(upperci),
            lowerci = sum(lowerci))

probloss_pop %>%
  filter(country == "France", 
         kintype == "Parents", 
         age == "0-14", 
         month <= 16) %>%
  ungroup() %>%
  summarize(orphans_France = sum(magnitude),
            upperci = sum(upperci),
            lowerci = sum(lowerci))
```
```{r}
probloss_pop %>%
  filter(country %in% country_graph) %>%
  ggplot(mapping = 
           aes(x = date, 
               y = magnitude,
               group = interaction(age, sex))) +
  geom_ribbon(aes(ymin = lowerci, ymax = upperci), alpha = 0.2) +
  geom_line(aes(color = age, linetype = sex)) +
  facet_grid(rows = vars(kintype), cols = vars(country), scales = "fixed") +
  theme_bw() +
  labs(x = "Month and Year", y = "Change in kin loss", 
       color = "Age", linetype = "Sex") + 
  theme(axis.text.x = element_text(angle = -45, vjust = 0.5, hjust = 0)) +
  scale_color_viridis_d()
```

```{r}
probloss_total <- probloss_pop %>%
  filter(country %in% country_graph, month <= 18) %>%
  ungroup() %>%
  group_by(country, sex, age, kintype) %>%
  summarize(kinloss = sum(magnitude, na.rm = T),
            upperci = sum(upperci, na.rm = T),
            lowerci = sum(lowerci, na.rm = T))
```

```{r}
#Grayscale version: currently used
probloss_total %>%
  mutate(kinloss = if_else(sex == "Male", -kinloss, kinloss),
         upperci = if_else(sex == "Male", -upperci, upperci),
         lowerci = if_else(sex == "Male", -lowerci, lowerci)) %>%
ggplot(aes(x = age, y = kinloss/1000, fill = sex,
           ymin=lowerci/1000, 
           ymax=upperci/1000)) + 
  geom_bar(data = . %>% filter(sex == "Female"), stat = "identity") + 
  geom_bar(data = . %>% filter(sex == "Male"), stat = "identity") +
  geom_errorbar(data = . %>% filter(sex == "Male"), width = 0.5, 
                position = position_dodge()) +
  geom_errorbar(data = . %>% filter(sex == "Female"), width = 0.5,
                  position = position_dodge()) +
    scale_y_continuous(breaks = seq(-100, 100, 50),
                      labels = as.character(c(seq(100, 50, -50), seq(0, 100, 50)))) +
  coord_flip() + 
  theme_bw() +
  scale_fill_grey()+
  facet_nested(rows = vars(kintype), cols = vars(country), scales = "fixed") +
  labs(x = "Age", y = "Number of individuals experiencing kin loss (1000s)", fill = "Sex", title = "Population Experiencing Excess Bereavement by Country") + 
  theme(legend.position = "bottom")

ggsave("~/covid_simulation/Output/paper_figures/compare_magnitude_total.pdf",
       width = 17.8, units = "cm")
```



