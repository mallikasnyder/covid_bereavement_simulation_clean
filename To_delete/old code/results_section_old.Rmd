---
title: "Methods and Results Section"
output:
  html_document:
    df_print: paged
---

## Data Preparation

```{r message=FALSE}
#Load functions
#Source functions and packages
source("~/covid_simulation/Kin_death/01_load_functions.R")
source('~/covid_simulation/Kin_death/functions_bereavement.R')

#Require this additional packages
require(broom)
require(countrycode)
require(ggrepel)
require(viridis)

#Load data: currently, this points to the latest version with data for the first wave
data <- get(load(file = "~/covid_simulation/Data/final_data_firstwave.RData"))
```

```{r}
#Find numbers for indices for each country
indices <- data$numbers %>%
  group_by(country) %>%
  summarize(max_index = min(nsims))
```


```{r}
#Burden of bereavement object
kin_test <-data$kin_bb %>%
  full_join(., indices, by = c("country" = "country")) %>%
  filter(!is.na(scenario)) %>% 
  mutate(sex = ifelse(grepl("f1", category), "F", "M"),
         age = gsub("f[0-1]{1}", "", category),
         category = NULL) %>%
  ungroup() %>%
  group_by(country, scenario, sex, age, kintype) %>%
  mutate(index = row_number(), category = NULL) %>%
  filter(index <= max_index) %>%
  ungroup() %>%
  pivot_wider(id_cols = c("country", "sex", "age", "kintype", "index"), 
              names_from = "scenario", 
              values_from = c("mean_pre_with", "sd_pre_with", "n_withkin", 
                              "mean_post_with", "sd_post_with", "sim.id", "n_losekin", "n_total")) %>%
  mutate(total_pre_with_covid = mean_pre_with_covid*n_withkin_covid,
         total_post_with_covid = mean_post_with_covid*n_withkin_covid,
         total_pre_with_other = mean_pre_with_other*n_withkin_covid,
         total_post_with_other = mean_pre_with_other*n_withkin_other,
         n_withkin = (n_withkin_covid + n_withkin_other)/2,
         n_losekin = (n_losekin_covid + n_losekin_other)/2,
         n_total = (n_total_covid + n_total_other)/2) %>%
  group_by(country, age, index, sim.id_covid, kintype) %>%
  summarize(total_pre_with_covid = sum(total_pre_with_covid, na.rm = T),
        total_post_with_covid = sum(total_post_with_covid, na.rm = T),
         total_pre_with_other = sum(total_pre_with_other, na.rm = T),
         total_post_with_other = sum(total_post_with_other, na.rm = T),
        n_withkin = sum(n_withkin, na.rm = T),
        n_losekin = sum(n_losekin, na.rm = T),
        n_total = sum(n_total, na.rm = T))
```
  group_by(country, age, index) %>%
  summarize(mean_pre_with)
  mutate(bereavement_covid = (mean_pre_with_covid - mean_post_with_covid),
         bereavement_other = (mean_pre_with_other - mean_post_with_other),
         n_withkin = (n_withkin_covid + n_withkin_other)/2,
         n_losekin = (n_losekin_covid+n_losekin_other)/2,
         n_total = (n_total_covid + n_total_other)/2,
         pc_withkin = (n_withkin/n_total)*100,
         pc_losekin = 100*(n_losekin/n_withkin),
         ebr = 100*(bereavement_covid)/(bereavement_other),
         ccode = countrycode(gsub("_", " ", country), 
                             origin = 'country.name', destination = 'iso3c'))
```


# Kin ratio object
  kin_structure <- data$kin_ratio %>%
    full_join(., indices, by = c("country" = "country")) %>%
    filter(!is.na(scenario)) %>% 
    mutate(sex = ifelse(grepl("f1", category), "F", "M"),
           age = gsub("f[0-1]{1}", "", category),
           category = NULL) %>%
    ungroup() %>%
    group_by(country, scenario, sex, age, kintype) %>%
    mutate(index = row_number(), category = NULL) %>%
    filter(index <= max_index) %>%
    ungroup() %>%
    pivot_wider(id_cols = c("country", "sex", "age", "kintype", "index"), 
                names_from = "scenario", 
                values_from = c("count_all", "sd_all", "count_female", "count_male",
                                "count_65plus", "count_below65", "n_egos", "sim.id")) %>%
    mutate(ccode = countrycode(gsub("_", " ", country), 
                               origin = 'country.name', destination = 'iso3c'),
           count_all_diff = count_all_covid - count_all_other)

#Death rates object
  death_rates <- data$death_rates %>%
  full_join(., indices, by = c("country" = "country")) %>%
  filter(!is.na(scenario)) %>% 
  mutate(sex = ifelse(fem == 1, "F", "M")) %>%
  ungroup() %>%
  group_by(country, scenario, sex, age) %>%
  mutate(index = row_number(), fem = NULL) %>%
  filter(index <= max_index) %>%
  ungroup() %>%
  pivot_wider(id_cols = c("country", "sex", "age", "index"), 
              names_from = "scenario", 
              values_from = c("n_num", "n_den", "value", "sim.id")) 
  
  #Object used for excess mortality analysis
  em <- death_rates %>%
  filter(age %ni% c("0-14", "all_sum", "all_mid")) %>%
  ungroup() %>%
  group_by(index, country, sim.id_covid, sim.id_other) %>%
  summarize(n_num_covid = sum(n_num_covid, na.rm = T),
            n_num_other = sum(n_num_other, na.rm = T)) %>%
    mutate(em15 = 100*((n_num_covid - n_num_other)/n_num_other))
```
## Methods

### Figure A: Excess Mortality in the STMF data compared to excess mortality in simulation output

Note: this may be better suited to the appendix. Why does Chile have such low excess mortality rates? We can see if we examine the simulation results individually that the results are very unstable (some very high, some very low). This may be worth noting. 

```{r}
#Calculate STMF excess mortality based on the code in MakeFactor.R, with modifications
 stmf <- fread("~/covid_simulation/Rcode/stmf-mar9-run.csv", stringsAsFactors = F)
  names(stmf) <- tolower(names(stmf)) #Make names lowercase

  #Keeping countries that only have data for 2020
  keepcountry <- unique(stmf$countrycode[which(stmf$year == 2020)])
  
  #Pivoting the STMF data into long format
  adj.total <- stmf %>%
    dplyr::select(-c(split, splitsex, forecast)) %>% #removing variables
    filter(countrycode %in% keepcountry) %>%
    pivot_longer(-c(year, week, countrycode, sex), 
                 names_to = c("type", "age"), values_to = "rate", names_sep = 1) %>% #pivoting
    pivot_wider(names_from = "type", values_from = "rate") %>%
    mutate(death_count = d, #renaming and generating new versions of variables
           death_rate = r,
           age = gsub("85p", "85-99", gsub("_", "-", age)),
           country = countrycode,
           sex = if_else(sex %in% c("f"), "Female", if_else(sex %in% c("m"), "Male", "b"))) %>%
    filter(age != c("total", "0-14"), between(year, 2016, 2020), sex != "b") %>%
    group_by(country, year, week) %>%
    summarize(deaths15 = sum(death_count, na.rm = T))


  #STMF currently reports the UK estimate for England and Wales, Scotland, and Northern Ireland separately; we combine them into one country and use that estimate for the UK
  #Seeing if we need to adjust the UK estimate: we see if we have more than one containing the code GBR
  adjustUK <- if_else(length(grep("GBR", levels(as.factor(adj.total$country)))) > 1, T, F)
  
  #Print whether we need to adjust this
  print(paste("UK estimate being constructed from", length(grep("GBR", levels(as.factor(adj.total$country)))), "entities"))
  
  if (adjustUK <- T) {
    #England and Wales, Scotland, and NI may go up to different number of weeks. 
    #Make sure we have the same number of weeks for each
     week_final_uk <-  adj.total %>% 
       filter(grepl("GBR", country), year == 2020) %>%
       ungroup() %>%
       group_by(country) %>%
       summarize(max_week = max(week), .groups = "keep") %>%
       ungroup() %>%
       summarize(min_week = min(max_week)) %>%
       pull(min_week)
    
    #Now construct a single estimate for the UK
    adj.total.uk <- adj.total %>% 
      filter(grepl("GBR", country) & week <= week_final_uk) %>%
      ungroup() %>%
      group_by(year, week) %>%
      summarize(deaths15 = sum(deaths15), .groups = "keep") %>% #Adding up UK estimates
      mutate(country = "GBR") #Creating one country code
    
    adj.total2 <- adj.total %>% 
      filter(!grepl("GBR", country)) %>% #Combining them with all other countries in the dataset
      bind_rows(adj.total.uk)
  } else {
    adj.total2 <- adj.total
  }
    
  final_week <- 24
  
  #Now convert weekly data into monthly data
    adj.monthly <- adj.total2 %>%
      filter(week <= final_week) %>% #removing all data after a set cutoff point for comparability between countries
      mutate(month = as.numeric(as.factor(cut(week, breaks = seq(1, final_week+1, by = 4), 
                                              right = FALSE)))) %>%
      ungroup() %>%
      filter(month %in% c(3,4,5,6)) %>%
      group_by(country, year) %>%
      summarize(deaths15 = sum(deaths15), .groups = "keep") %>% #generating monthly death counts and exposures
      mutate(period = if_else(year %in% c(2016:2019), "Past", "Current"))
    
  #Making sure this worked
  print(paste("UK estimates still need adjusting: ", if_else(length(grep("GBR", levels(as.factor(adj.monthly$country)))) > 1, T, F)))
  
 #Now we can generate excess mortality

  adj.past <- adj.monthly %>%  #Calculate average for past 4-year period
    filter(period == "Past") %>%
    ungroup() %>%
    group_by(country) %>%
    summarize(mean_past_deaths15 = mean(deaths15))

   adj.current <- adj.monthly %>% filter(period == "Current") %>% #Find current mx values
    ungroup() %>%
    mutate(current_deaths15 = deaths15) %>% 
              dplyr::select(-c(year, deaths15))
  
    #Getting final monthly factors
    adj.monthly.final <- left_join(adj.past, adj.current, #Combine past and current values
                                by = c("country" = "country")) %>%
      filter(country %ni% c("TWN")) %>% #Removing Taiwan for now
    mutate(mean_past_deaths15 = if_else(mean_past_deaths15 == 0, 10^-6, mean_past_deaths15),
          stmf_em15 = 100*(current_deaths15 - mean_past_deaths15)/mean_past_deaths15,
           country_name =  countrycode(substr(country, 1, 3), origin = "iso3c", destination = "un.name.en"),
           country_name = c(gsub(" ", "_", 
                                 gsub("United Kingdom of Great Britain and Northern Ireland",
                                      "United Kingdom", country_name))))

```

```{r}
#Calculate country mean excess mortality across simulations
em_mean <- em %>%
  ungroup() %>%
  group_by(country) %>%
  summarize(em15_mean = mean(em15, na.rm = T))

#Merge the two datasets
em_compare <- full_join(em_mean, adj.monthly.final, by = c("country" = "country_name"))
```

```{r}
#Plot their correlation
em_compare %>%
  ggplot(aes(x = stmf_em15, y = em15_mean)) + geom_point() + 
  geom_text_repel(aes(label = substr(country.y, 1, 3)), max.overlaps = 10) +
  labs(x = "Excess Deaths in STMF Data (15+) (%)", y = "Excess Mortality in Simulated Data (15+) (%)", title = "Comparison between Actual and Simulated Excess Mortality") +
  theme_bw()

ggsave("~/covid_simulation/Output/paa_graphs/mortality_rates_compare.png")
```

### Figure B: Death rates by country

```{r}
lm(em15 ~ 0 + country, data = em) %>%
  tidy %>%
  mutate(country = gsub("country", "", term),
         country = gsub("_", " ", country)) %>%
  ggplot(aes(reorder(country, estimate), y=estimate, ymin=estimate - qnorm(0.95)*std.error, ymax=estimate + qnorm(0.95)*std.error)) +
  geom_hline(yintercept=0, linetype="11", colour="grey60") +
  geom_errorbar(width=0.1) + 
  geom_point() +
  coord_flip() +
  labs(y = "Excess Mortality Above 15", x = "Country", title = "Excess Mortality by Country (Simulation Results)") +
  theme_bw()

ggsave("~/covid_simulation/Output/paa_graphs/em15_bycountry.png")
```


### Figure C: Mortality and Age structure by country


```{r}
oadr <- death_rates %>%
  filter(age %ni% c("all_mid", "all_sum", "0-14")) %>%
  mutate(category = if_else(age == "65+", "old", "young")) %>%
  group_by(country, index, sim.id_covid, sim.id_other, category) %>%
  summarize(n_den_covid = sum(n_den_covid, na.rm = T),
            n_den_other = sum(n_den_other, na.rm = T),
            n_den_all = (n_den_covid + n_den_other)/2) %>%
  pivot_wider(id_cols = c("country", "index", "sim.id_covid", "sim.id_other"), names_from = "category", values_from = "n_den_all") %>%
  mutate(oadr = (old/young)) %>%
  ungroup() %>%
  group_by(country) %>%
  summarize(oadr = mean(oadr, na.rm = T))


oadr_mortality <- merge(em_mean, oadr)

oadr_mortality %>%
  ggplot(aes(x = oadr, y = em15_mean)) + geom_point() + 
  labs(x = "Old-Age Dependency Ratio", y = "Excess Mortality (15+) (%)",
       title = "Age Structure and Excess Mortality") +
  geom_text_repel(aes(label = substr(country, 1, 3)), max.overlaps = 10) +
  theme_bw()

ggsave("~/covid_simulation/Output/paa_graphs/age_str_mortality.png")
  
```

### Figure D: Kin Availability by Age

```{r}
kin_ebr %>%
  ungroup() %>%
  group_by(kintype, age) %>%
  summarize(n_withkin = mean(n_withkin, na.rm = T),
            n_losekin = mean(n_losekin, na.rm = T),
            pc_withkin = mean(pc_withkin, na.rm = T),
            n_total = mean(n_total, na.rm = T)) %>%
  filter(kintype %ni% c("nuclear", "spouse")) %>%
  ungroup() %>%
  mutate(kintype = str_to_title(if_else(kintype == "gparents", "grandparents", kintype)),
         kintype = ordered(kintype, levels = c("Grandparents", "Parents", "Siblings", "Children"))) %>%
  ggplot() + geom_bar(aes(x = kintype, y = pc_withkin, fill = age), position = "dodge", stat = "identity") + labs(x = "Type of Kin", y = "% with at least one relative in Feb 2020", title = "% Individuals with Kin by Age", fill = "Age Group") + 
  theme_bw() + scale_fill_viridis(discrete = T)

ggsave(file = "~/covid_simulation/Output/paa_graphs/kin_dist_byage.png")
```

### Figure E: Kin Availability by Country

```{r}
kin_ebr %>%
  ungroup() %>%
  group_by(country, kintype, age) %>%
  summarize(n_withkin = mean(n_withkin, na.rm = T),
            n_losekin = mean(n_losekin, na.rm = T),
            pc_withkin = mean(pc_withkin, na.rm = T),
            n_total = mean(n_total, na.rm = T)) %>%
  filter(kintype %ni% c("nuclear", "spouse")) %>%
  ungroup() %>%
  mutate(kintype = str_to_title(if_else(kintype == "gparents", "grandparents", kintype)),
         kintype = ordered(kintype, levels = c("Grandparents", "Parents", "Siblings", "Children"))) %>%
  ggplot() + geom_tile(aes(y = country, x = age, fill = pc_withkin)) + 
  facet_grid(~kintype) + scale_fill_viridis() + 
  theme_bw() + 
  labs(x = "Age", y = "Country", fill = "% with at least one relative in Feb 2020")
```

Note: an alternative way of visualizing this is to plot comparisons to the mean or to some reference


## Results (in progress)

As a first step in our inquiry, we estimated across countries which age groups would be predicted to experience the greatest loss, and for which kin relations. Figure X presents results for one measure of kin loss, changes in the probability of loss. 
\par
```{r}
#Calculate probabilties of loss by age
prob_loss_age <- kin_ebr %>%
  ungroup() %>%
  #filter(pc_withkin > 1) %>%
  group_by(kintype, age, sex) %>%
  summarize(n_withkin_covid = mean(n_withkin_covid, na.rm = T),
            n_withkin_other = mean(n_withkin_other, na.rm = T),
            n_losekin_covid = mean(n_losekin_covid, na.rm = T),
            n_losekin_other = mean(n_losekin_other, na.rm = T),
            pc_withkin = mean(pc_withkin, na.rm = T),
            bereavement_covid = mean(bereavement_covid, na.rm = T),
            bereavement_other = mean(bereavement_other, na.rm = T),
            bereavement_abs_diff = bereavement_covid - bereavement_other) %>%
  mutate(probloss_covid = 100*(n_losekin_covid/n_withkin_covid),
         probloss_other = 100*(n_losekin_other/n_withkin_other),
         probloss_rel_diff = 100*(probloss_covid - probloss_other)/probloss_other,
         probloss_abs_diff = probloss_covid - probloss_other)

prob_loss_age %>%
  filter(sex == "M") %>%
  filter(kintype %ni% c("nuclear", "spouse")) %>%
  filter(pc_withkin > 1) %>%
  ungroup() %>%
  mutate(kintype = str_to_title(if_else(kintype == "gparents", "grandparents", kintype)),
         kintype = ordered(kintype, levels = c("Grandparents", "Parents", "Siblings", "Children"))) %>%
  ggplot() + geom_bar(aes(x = kintype, y = probloss_abs_diff/100, fill = age), position = "dodge", stat = "identity") + labs(title = "Excess Probability of Losing Kin (Male)", y = "% point difference for all individuals", x = "Type of Kin", fill = "Age Group") + theme_bw() + scale_fill_viridis(discrete = T)


prob_loss_age %>%
  filter(sex == "F") %>%
  filter(kintype %ni% c("nuclear", "spouse")) %>%
  filter(pc_withkin > 1) %>%
  ungroup() %>%
  mutate(kintype = str_to_title(if_else(kintype == "gparents", "grandparents", kintype)),
         kintype = ordered(kintype, levels = c("Grandparents", "Parents", "Siblings", "Children"))) %>%
  ggplot() + geom_bar(aes(x = kintype, y = probloss_abs_diff/100, fill = age), position = "dodge", stat = "identity") + labs(title = "Excess Probability of Losing Kin (Female(", y = "% point difference for all individuals", x = "Type of Kin", fill = "Age Group") + theme_bw() + scale_fill_viridis(discrete = T)

```

Two points are especially worth noting here. One is that the mortality patterns are manifested here. The second is that this kin loss is generational. We see also that the disaggregation by sex is not/is important. This informs our approach going forward. 
\par
The next area of variation to consider is differences across countries. We report this in the following heatmap.
\par

```{r}
prob_loss_age_country <- kin_ebr %>%
  ungroup() %>%
  filter(pc_withkin > 1) %>%
  group_by(country, kintype, age) %>%
  summarize(n_withkin_covid = mean(n_withkin_covid, na.rm = T),
            n_withkin_other = mean(n_withkin_other, na.rm = T),
            n_losekin_covid = mean(n_losekin_covid, na.rm = T),
            n_losekin_other = mean(n_losekin_other, na.rm = T),
            pc_withkin = mean(pc_withkin, na.rm = T)) %>%
  mutate(probloss_covid = 100*(n_losekin_covid/n_withkin_covid),
         probloss_other = 100*(n_losekin_other/n_withkin_other),
         probloss_rel_diff = 100*(probloss_covid - probloss_other)/probloss_other,
         probloss_abs_diff = probloss_covid - probloss_other)
```

```{r}
prob_loss_age_country %>%
  filter(kintype %ni% c("nuclear", "spouse")) %>%
  mutate(country = gsub("_", " ", country)) %>%
  ggplot() + geom_tile(aes(y = country, x = age, fill = probloss_abs_diff)) + 
  facet_grid(~kintype) + scale_fill_viridis() + 
  theme_bw() + 
  labs(x = "Age", y = "Country", fill = "Excess Probability of Losing Kin (% pt)")

#ggsave("~/covid_simulation/Output/paa_graphs/probloss_bycountry.png")
```



